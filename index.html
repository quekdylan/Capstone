<!--
  CAPSTONE DASHBOARD



  ROS topics used:

  - /camera (Subscribe)
  Used for displaying camera feed

  - /map  (Subscribe)
  Used for displaying LIDAR map

  - /commands (Publish)
  Used for sending commands (eg. Emergency stop/Return to home)

  - /wagon_capacity (Subscribe)
  Used for displaying wagon capacity
  data: [int] percentage

  - /wagon_contents (Subscribe)
  Used for displaying wagon contents under view metrics modal.
  data format: [string] names of items detected
-->


<head>
  <title>Capstone Dashboard</title>
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
  <script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script type="text/javascript" src="http://static.robotwebtools.org/EaselJS/current/easeljs.min.js"></script>
  <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <!--<script src="https://static.robotwebtools.org/keyboardteleopjs/current/keyboardteleop.min.js"></script>-->
  <!--<script src="//yoannmoinet.github.io/nipplejs/javascripts/nipplejs.js"></script>-->
  <script type="text/javascript" src="http://static.robotwebtools.org/ros2djs/current/ros2d.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>  
  <script src="https://docs.opencv.org/master/opencv.js" type="text/javascript"></script>
</head>

<script>
  var publishImmidiately = true;
  var robot_IP;
  var manager;
  var ros;
  var items = {};

  function set_ip(){
    if(event.key == 'Enter') {
      var ip = document.querySelector("#ip").value;
      var url = window.location.href.split('?')[0];
      url = (url + "?ip=" + ip);
      window.location.href = url;
    }
  }

  function emergency_stop() {
    
    var dashboard = new ROSLIB.Topic({
      ros : ros,
      name : "/commands",
      messageType : "std_msgs/String"
    });
    var msg = new ROSLIB.Message({
        data : "emergency_stop"
    });
    dashboard.publish(msg);
    console.log("emergency_stop");
    $('.toast_es').toast('show');
  }

  function return_home() {
    var dashboard = new ROSLIB.Topic({
      ros : ros,
      name : "/commands",
      messageType : "std_msgs/String"
    });
    var msg = new ROSLIB.Message({
        data : "return_home"
    });
    dashboard.publish(msg);
    console.log("return_home");
    $('.toast_rth').toast('show');
  }

  window.onload = function () {
      // robot_IP = location.hostname;
      // set robot address statically
      const urlParams = new URLSearchParams(window.location.search);
      const myParam = urlParams.get('ip');
      if(myParam != null) {
        robot_IP = myParam;
      }
      else {
        robot_IP = "192.168.52.8"; //default
      }
      console.log(robot_IP);

      // Init handle for rosbridge_websocket
      ros = new ROSLIB.Ros({
          url: "ws://" + robot_IP + ":9090"
      });

      ros.on('close', function() {
          console.log('Connection closed');
          document.getElementById('connecting').style.display = 'none';
          document.getElementById('connected').style.display = 'none';
          document.getElementById('disconnected').style.display = 'inline';
      });

      ros.on('error', function(error) {
          console.log('Error');
          document.getElementById('connecting').style.display = 'none';
          document.getElementById('connected').style.display = 'none';
          document.getElementById('disconnected').style.display = 'inline';
      });

      ros.on('connection', function() {
          console.log('Connection successful!');
          document.getElementById('connecting').style.display = 'none';
          document.getElementById('connected').style.display = 'inline';
          document.getElementById('disconnected').style.display = 'none';

          // get handle for video placeholder
          video1 = document.getElementById('video1');
          // Populate video source 
          video1.src = "http://" + robot_IP + ":8080/stream?topic=/camera/image_raw";
          video1.onload = function () {
            // onload
          };
          // Create the main viewer.
          var viewer = new ROS2D.Viewer({
            divID : 'map',
            width : $(window).width()/2,
            height : $('#body').height()
          });

          // Setup the map client.
          var gridClient = new ROS2D.OccupancyGridClient({
            ros : ros,
            rootObject : viewer.scene,
            continuous: true
          });

          // Scale the canvas to fit to the map
          gridClient.on('change', function(){
            viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
            viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
          });

          // Subscribe to wagon capacity
          var wagon_capacity = new ROSLIB.Topic({
            ros : ros,
            name : '/wagon_capacity',
            messageType : 'std_msgs/Int32'
          });

          wagon_capacity.subscribe(function(message) {
            document.getElementById('capacity').style.width = String(message.data) + "%";
            console.log('Received message on ' + wagon_capacity.name + ': ' + message.data);
          });



          // Subscribe to camera
          var wagon_capacity = new ROSLIB.Topic({
            ros : ros,
            name : '/camera',
            messageType : 'std_msgs/Int32'
          });

          wagon_capacity.subscribe(function(message) {
            document.getElementById('capacity').style.width = String(message.data) + "%";
            console.log('Received message on ' + wagon_capacity.name + ': ' + message.data);
          });

          // Subscribe to wagon contents
          var wagon_contents = new ROSLIB.Topic({
            ros : ros,
            name : '/wagon_contents',
            messageType : 'std_msgs/String'
          });

          wagon_contents.subscribe(function(message) {
            item = String(message.data);
            if(item in items) {
              items[item] += 1
            }
            else {
              items[item] = 1
            }
            console.log('Received message on ' + wagon_contents.name + ': ' + message.data);
            $('#toast_wc_content').html("Detected " + item);
            $('.toast_wc').toast({delay: 2000});
            $('.toast_wc').toast('show');
          });
      });
  }

  function view_metrics(){
    // Load wagon contents
    contents = [['Item', 'Quantity']];
    //items = {"Plastic Bottle": 8, "Tissue": 2};
    for (var item in items) {
      contents.push([item, items[item]]);
    };
    console.log(contents);

    // Load google charts
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    // Draw the chart and set the chart values
    function drawChart() {
      var data = google.visualization.arrayToDataTable(contents);
      var options = {
        'title':'All items collected', 
        'width':550, 
        'height':400, 
        'chartArea':{'width':'100%','height':'80%'},
        'backgroundColor': '#111', 
        'titleTextStyle': {'color': 'white', 'fontSize' : 16},
        'legend': {'textStyle': {'color': 'white'}}
      };

      // Display the chart inside the <div> element with id="piechart"
      var chart = new google.visualization.PieChart(document.getElementById('piechart'));
      chart.draw(data, options);
    }
    $('.metrics_modal').modal('show')
  }
</script>

<body style='background-color:#000; position: relative;'>
  <nav class="navbar navbar-expand-md" style="background-color: #000; padding: 10px 20px;">
    <span class="navbar-brand" style="font-size: 2em; padding: 0;">&#x1F916;</span>
      <ul class="navbar-nav mr_auto" style='display: flex; align-items:center;'>
          <div>
              <div>
                <button type="button" class="btn btn-info" id='connecting' disabled>
                    <span class="sr-only">Connecting</span>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </button>
              </div>
              <div>
                <button type="button" class="btn btn-success" id='connected' disabled style='display: none;'>Connected</button>
              </div>
              <div>
                <button type="button" class="btn btn-danger" id='disconnected' disabled data-bs-toggle="tooltip" style='display: none;'>Not Connected</button>
              </div>
          </div>
          <button type="button" class="btn btn-link" onclick="$('.ip_modal').modal('show')">Change IP</button>
          <div class="modal fade ip_modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
              <div class="modal-content" style="background-color: #111;">
                <div class="modal-body">
                  <p style='color: #999'>On https, ensure 'Insecure content' is enabled</p>
                  <p style='color: #999'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill" viewBox="0 0 16 20" preserveAspectRatio="none">
                      <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                    </svg>
                     > Site Settings > Insecure Content
                  </p>
                  <input class="form-control bg-dark" id="ip" style="color: #aaa;" placeholder="192.168.0.1" onkeydown="set_ip(this)">
                </div>
              </div>
            </div>
          </div>
      </ul>
  </nav>

  <!--TOAST BOX-->
  <div style="position: absolute; top: 50px; right: 10px; z-index: 999;">
    <div class="toast d-flex align-items-center text-white bg-dark border-0 toast_es" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">
        Request sent: Emergency Stop
      </div>
      <button type="button" class="btn-close ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast d-flex align-items-center text-white bg-dark border-0 toast_rth" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">
        Request sent: Return to Home
      </div>
      <button type="button" class="btn-close ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>

  <div style="position: absolute; top: 120px; left: 10px; z-index: 999;">
    <div class="toast d-flex align-items-center text-white bg-dark border-0 toast_wc" role="alert" aria-live="assertive" aria-atomic="true" style="width: fit-content;">
      <button type="button" class="btn-close ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
      <div class="toast-body" id="toast_wc_content">
        Item detected
      </div>
    </div>
  </div>

  <div style='display: flex; flex-flow: row wrap;'>
    <!-- CAMERA -->
    <div style='width: 50%; position: relative;' id='body'>
        <span style='position: absolute; top: 10px; left: 10px;' class='badge bg-info'>CAMERA</span>
        <span style='position: absolute; top: 10px; left: 88px;' class='badge bg-dark'>/camera/image_raw</span>
        <img src="img/no_signal.png" class="p-1 bg-dark" alt="" id="video1" style='width: 100%;' />
    </div>
    <!-- LIDAR -->
    <div style='width: 50%; position: relative;'>
        <span style='position: absolute; top: 10px; left: 10px;' class='badge bg-info'>LIDAR</span>
        <span style='position: absolute; top: 10px; left: 70px;' class='badge bg-dark'>/map</span>
        <div id="map" class="p-1 bg-dark" alt="" id="video2" style='width: 100%;'></div>
    </div>
  </div>

  
  <!--Metrics modal-->
  <div class="modal fade metrics_modal" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style='color: white; background-color: #111;'>
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Metrics</h5>
        </div>
        <div class="modal-body">
          <div id='piechart'></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTROL PANEL -->
  <div style='position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: #111; border-radius: 10px; padding: 20px; box-shadow: 0px 0px 50px 10px black;'>
      <span style='color: #666;'>Wagon Capacity</span>
      <div class="progress" style='height: 10px; width: 100%; background-color: #222; margin-bottom: 20px;'>
        <div class="progress-bar bg-info" id='capacity' role="progressbar" style="width: 20%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <button type="button" class="btn btn-outline-danger" onclick="emergency_stop()">Emergency Stop</button>
      <button type="button" class="btn btn-outline-warning" onclick="return_home()">Return to Home</button>
      <button type="button" class="btn btn-outline-info" onclick="view_metrics()">View Metrics</button>
  </div>
</div>

</body>
